<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Mémento opérationnel IA – RCH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Police Inter -->
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

  <!-- Styles -->
  <link rel="stylesheet" href="style.css" />

  <!-- Librairies externes -->
  <!-- Compression -->
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <!-- Génération de QR code -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <!-- Lecture de QR code (caméra + fichier) -->
  <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
</head>
<body>
  <div class="app-root">
    <!-- En-tête -->
    <header class="app-header">
      <div class="header-left">
        <div class="logo-placeholder">
          ENSOSP
        </div>
        <div class="header-titles">
          <div class="header-title-main">Mémento opérationnel IA</div>
          <div class="header-title-sub">Usage opérationnel IA – Risque chimique</div>
        </div>
      </div>
      <div class="header-right">
        <span id="app-version" class="header-version"></span>
      </div>
    </header>

    <!-- Onglets -->
    <nav class="tabs-bar">
      <button id="tab-btn-read" class="tab-button active">
        Lecture de fiche (scan QR)
      </button>
      <button id="tab-btn-create" class="tab-button">
        Création de fiche
      </button>
    </nav>

    <!-- Contenu principal -->
    <main class="app-main">
      <!-- Onglet Lecture -->
      <section id="tab-read" class="tab-content active">
        <div class="card">
          <h2>Lecture de fiche (scan QR)</h2>

          <div class="read-controls">
            <div class="read-buttons-row">
              <button id="btn-start-camera" class="btn primary">Activer la caméra</button>
              <label for="file-input" class="btn secondary">
                <span class="upload-icon">⭳</span> Importer image
              </label>
              <input id="file-input" type="file" accept="image/*" style="display:none" />
              <button id="btn-reset-read" class="btn ghost">Réinitialiser</button>
            </div>

            <div class="video-wrapper" id="video-wrapper">
              <video id="qr-video" muted playsinline></video>
            </div>

            <div id="read-error" class="error-message" aria-live="polite"></div>
          </div>

          <hr class="section-separator">

          <div id="read-form" class="read-form" style="display:none;">
            <h3>Métadonnées de la fiche</h3>
            <div class="form-row">
              <div class="form-group">
                <label>Catégorie</label>
                <input id="read-category" type="text" readonly />
              </div>
              <div class="form-group">
                <label>Titre de la fiche</label>
                <input id="read-title" type="text" readonly />
              </div>
            </div>

            <h3>Variables</h3>
            <div id="read-variables-container" class="variables-read-container">
              <!-- Champs dynamiques injectés ici -->
            </div>

            <div class="form-group">
              <label for="read-extra-info">Informations complémentaires</label>
              <textarea id="read-extra-info" rows="3" placeholder="Ajouter des éléments contextuels ou des précisions opérationnelles..."></textarea>
            </div>

            <h3>Prompt compilé</h3>
            <div class="form-group">
              <textarea id="compiled-prompt" rows="8" readonly></textarea>
            </div>

            <div class="form-actions">
              <button id="btn-copy-prompt" class="btn secondary">Copier le prompt</button>
            </div>

            <h3>Envoyer vers une IA</h3>
            <p class="help-text">
              Boutons colorés selon l’indice de confiance IA : vert = 3 (recommandé) · orange = 2 (acceptable) · gris = 1 (non cliquable).
            </p>

            <div class="ai-buttons-row">
              <button id="btn-send-chatgpt" class="btn ia-btn disabled" data-ia="chatgpt" disabled>ChatGPT</button>
              <button id="btn-send-perplexity" class="btn ia-btn disabled" data-ia="perplexity" disabled>Perplexity</button>
              <button id="btn-send-mistral" class="btn ia-btn disabled" data-ia="mistral" disabled>Mistral</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Onglet Création -->
      <section id="tab-create" class="tab-content">
        <div class="card">
          <div class="card-header-row">
            <h2>Création de fiche</h2>
            <button id="btn-reset-create" class="btn ghost small">Réinitialiser</button>
          </div>

          <h3>Métadonnées de la fiche</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="meta-category">Catégorie</label>
              <input id="meta-category" type="text" placeholder="ex : Fuite, Explosion, Déversement..." />
            </div>
            <div class="form-group">
              <label for="meta-title">Titre de la fiche</label>
              <input id="meta-title" type="text" placeholder="ex : Fiche intervention ONU XXXX" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="meta-objective">Objectif de la fiche</label>
              <input id="meta-objective" type="text" placeholder="Objectif opérationnel/précision de l’usage..." />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="meta-author">Nom du concepteur</label>
              <input id="meta-author" type="text" />
            </div>
            <div class="form-group">
              <label for="meta-date">Date de mise à jour</label>
              <input id="meta-date" type="date" />
            </div>
            <div class="form-group">
              <label for="meta-version">Version</label>
              <input id="meta-version" type="text" placeholder="ex : V0.6" />
            </div>
          </div>

          <h3>Indices de confiance IA</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="trust-chatgpt">ChatGPT</label>
              <select id="trust-chatgpt">
                <option value="3">3 - Recommandée</option>
                <option value="2">2 - Acceptable</option>
                <option value="1">1 - À éviter</option>
              </select>
            </div>
            <div class="form-group">
              <label for="trust-perplexity">Perplexity</label>
              <select id="trust-perplexity">
                <option value="3">3 - Recommandée</option>
                <option value="2">2 - Acceptable</option>
                <option value="1">1 - À éviter</option>
              </select>
            </div>
            <div class="form-group">
              <label for="trust-mistral">Mistral</label>
              <select id="trust-mistral">
                <option value="3">3 - Recommandée</option>
                <option value="2">2 - Acceptable</option>
                <option value="1">1 - À éviter</option>
              </select>
            </div>
          </div>

          <h3>Variables (max. 10)</h3>
          <p class="help-text">
            Utilisez les identifiants de variables dans le pré-prompt avec la syntaxe <code>{{identifiant}}</code>.
          </p>
          <div id="variables-container" class="variables-container">
            <!-- Lignes de variables ajoutées dynamiquement -->
          </div>
          <button id="btn-add-variable" class="btn secondary">Ajouter une variable</button>

          <h3>Pré-prompt de la fiche</h3>
          <div class="form-group">
            <label for="preprompt">
              Texte du pré-prompt
              <span class="char-counter">
                (<span id="preprompt-count">0</span> / 10 000 caractères)
              </span>
            </label>
            <textarea id="preprompt" rows="8" maxlength="10000"
              placeholder="Tu es assistant de niveau RCH4... Utilise {{code_onu}}, {{produit}}, etc."></textarea>
          </div>

          <div class="form-actions">
            <button id="btn-generate-qr" class="btn primary">Générer le JSON + QR code</button>
          </div>

          <div id="create-error" class="error-message" aria-live="polite"></div>

          <div id="qr-section" class="qr-section" style="display:none;">
            <h3>QR code généré</h3>
            <p class="help-text">
              Ce QR code encode la fiche au format JSON compressé. Il est dimensionné pour une impression d’au moins 7 cm × 7 cm.
            </p>
            <div id="qr-output" class="qr-output"></div>
            <div class="form-actions">
              <button id="btn-download-qr" class="btn secondary">Télécharger le QR (PNG)</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Pied de page -->
    <footer class="app-footer">
      <span>© ENSOSP — Application Mémento opérationnel IA – RCH</span>
      <span>Développement : Cne Eddy Fischer – Cdt Anne Tirelle - V1</span>
    </footer>
  </div>

  <script>
    // Configuration du chemin du worker pour QrScanner
    if (window.QrScanner) {
      QrScanner.WORKER_PATH = 'https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js';
    }
  </script>
  <script src="app.js"></script>
</body>
</html>
